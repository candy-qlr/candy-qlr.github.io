<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/qiaolingyan/blog-img@master/vuepress/logo.4rs1px4f8j60.jpg"><title>Virtual DOM | qiao</title><meta name="description" content="happy day"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.19">
    <link rel="preload" href="/assets/js/runtime~app.89d2221a.js" as="script"><link rel="preload" href="/assets/css/styles.55340b42.css" as="style"><link rel="preload" href="/assets/js/640.35c7ecf5.js" as="script"><link rel="preload" href="/assets/js/app.983a575d.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.55340b42.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="https://cdn.jsdelivr.net/gh/qiaolingyan/blog-img@master/vuepress/logo.4rs1px4f8j60.jpg" alt="qiao"><span class="site-name can-hide">qiao</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/guide/js/" class="nav-link" aria-label="Js"><!--[--><!--]--> Js <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/webpack/" class="nav-link" aria-label="Webpack"><!--[--><!--]--> Webpack <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/vue/" class="nav-link router-link-active" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/react/" class="nav-link" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/SSR/" class="nav-link" aria-label="SSR"><!--[--><!--]--> SSR <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/nodejs/" class="nav-link" aria-label="NodeJs"><!--[--><!--]--> NodeJs <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/algorithm/" class="nav-link" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/CICD/" class="nav-link" aria-label="自动化部署"><!--[--><!--]--> 自动化部署 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/other/" class="nav-link" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/interview/" class="nav-link" aria-label="面试"><!--[--><!--]--> 面试 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分类"><span class="title">分类</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="分类"><span class="title">分类</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/source/basis/" class="nav-link" aria-label="前端基础建设与架构"><!--[--><!--]--> 前端基础建设与架构 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/link/" class="nav-link" aria-label="Link"><!--[--><!--]--> Link <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/guide/js/" class="nav-link" aria-label="Js"><!--[--><!--]--> Js <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/webpack/" class="nav-link" aria-label="Webpack"><!--[--><!--]--> Webpack <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/vue/" class="nav-link router-link-active" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/react/" class="nav-link" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/SSR/" class="nav-link" aria-label="SSR"><!--[--><!--]--> SSR <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/nodejs/" class="nav-link" aria-label="NodeJs"><!--[--><!--]--> NodeJs <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/algorithm/" class="nav-link" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/CICD/" class="nav-link" aria-label="自动化部署"><!--[--><!--]--> 自动化部署 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/guide/other/" class="nav-link" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/interview/" class="nav-link" aria-label="面试"><!--[--><!--]--> 面试 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分类"><span class="title">分类</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="分类"><span class="title">分类</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/source/basis/" class="nav-link" aria-label="前端基础建设与架构"><!--[--><!--]--> 前端基础建设与架构 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/link/" class="nav-link" aria-label="Link"><!--[--><!--]--> Link <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><section class="sidebar-group"><p class="sidebar-heading active">Vue</p><ul class=""><li><!--[--><a href="/guide/vue/Vue%E9%9D%A2%E8%AF%95%E9%A2%98.html" class="nav-link sidebar-link" aria-label="Vue 面试题"><!--[--><!--]--> Vue 面试题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/VueRouter.html" class="nav-link sidebar-link" aria-label="VueRouter-基础"><!--[--><!--]--> VueRouter-基础 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/VueRouter(%E4%BA%8C).html" class="nav-link sidebar-link" aria-label="VueRouter-原理"><!--[--><!--]--> VueRouter-原理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/vue%E5%93%8D%E5%BA%94%E5%BC%8F.html" class="nav-link sidebar-link" aria-label="Vue 响应式原理"><!--[--><!--]--> Vue 响应式原理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/vue%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F.html" class="nav-link sidebar-link" aria-label="Vue 组件通信"><!--[--><!--]--> Vue 组件通信 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/vuex.html" class="nav-link sidebar-link" aria-label="Vuex"><!--[--><!--]--> Vuex <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-link active" aria-label="Virtual DOM"><!--[--><!--]--> Virtual DOM <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#什么是-virtual-dom" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="什么是 Virtual DOM"><!--[--><!--]--> 什么是 Virtual DOM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#为什么使用-virtual-dom" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="为什么使用 Virtual DOM"><!--[--><!--]--> 为什么使用 Virtual DOM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#虚拟-dom-的作用" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="虚拟 DOM 的作用"><!--[--><!--]--> 虚拟 DOM 的作用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#virtual-dom-库" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Virtual DOM 库"><!--[--><!--]--> Virtual DOM 库 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#snabbdom-基本使用" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Snabbdom 基本使用"><!--[--><!--]--> Snabbdom 基本使用 <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#创建项目" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="创建项目"><!--[--><!--]--> 创建项目 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#导入-snabbdom" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="导入 Snabbdom"><!--[--><!--]--> 导入 Snabbdom <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#代码演示" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="代码演示"><!--[--><!--]--> 代码演示 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#snabbdom-源码解析" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Snabbdom 源码解析"><!--[--><!--]--> Snabbdom 源码解析 <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#如何学习源码" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="如何学习源码"><!--[--><!--]--> 如何学习源码 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#snabbdom-的核心" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Snabbdom 的核心"><!--[--><!--]--> Snabbdom 的核心 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#snabbdom-源码" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Snabbdom 源码"><!--[--><!--]--> Snabbdom 源码 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#h-函数" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="h 函数"><!--[--><!--]--> h 函数 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#vnode" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="VNode"><!--[--><!--]--> VNode <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#snabbdom" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="snabbdom"><!--[--><!--]--> snabbdom <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#init" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="init"><!--[--><!--]--> init <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#patch" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="patch"><!--[--><!--]--> patch <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#createelm" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="createElm"><!--[--><!--]--> createElm <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#patchvnode" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="patchVnode"><!--[--><!--]--> patchVnode <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#updatechildren" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="updateChildren"><!--[--><!--]--> updateChildren <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/guide/vue/%E8%99%9A%E6%8B%9FDOM.html#调试-updatechildren" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="调试 updateChildren"><!--[--><!--]--> 调试 updateChildren <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/guide/vue/diff%E7%AE%97%E6%B3%95.html" class="nav-link sidebar-link" aria-label="Diff 算法"><!--[--><!--]--> Diff 算法 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/guide/vue/封装vue组件库" class="nav-link sidebar-link" aria-label="封装vue组件库"><!--[--><!--]--> 封装vue组件库 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="virtual-dom"><a class="header-anchor" href="#virtual-dom">#</a> Virtual DOM</h1><h4 id="课程目标"><a class="header-anchor" href="#课程目标">#</a> 课程目标</h4><ul><li>了解什么是虚拟 DOM，以及虚拟 DOM 的作用</li><li>Snabbdom 的基本使用</li><li><strong>Snabbdom 的源码解析</strong></li></ul><h3 id="什么是-virtual-dom"><a class="header-anchor" href="#什么是-virtual-dom">#</a> 什么是 Virtual DOM</h3><ul><li><p><strong>Virtual DOM(虚拟 DOM)</strong>，是由普通的 JS 对象来描述 DOM 对象，因为不是真实的 DOM 对象，所以叫 Virtual DOM</p></li><li><p>真实 DOM 成员</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  s <span class="token operator">+=</span> key <span class="token operator">+</span> <span class="token string">&#39;,&#39;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">// 打印结果</span>
align<span class="token punctuation">,</span>title<span class="token punctuation">,</span>lang<span class="token punctuation">,</span>translate<span class="token punctuation">,</span>dir<span class="token punctuation">,</span>hidden<span class="token punctuation">,</span>accessKey<span class="token punctuation">,</span>draggable<span class="token punctuation">,</span>spellcheck<span class="token punctuation">,</span>autocapitalize<span class="token punctuation">,</span>contentEditable<span class="token punctuation">,</span>isContentEditable<span class="token punctuation">,</span>inputMode<span class="token punctuation">,</span>offsetParent<span class="token punctuation">,</span>offsetTop<span class="token punctuation">,</span>offsetLeft<span class="token punctuation">,</span>offsetWidth<span class="token punctuation">,</span>offsetHeight<span class="token punctuation">,</span>style<span class="token punctuation">,</span>innerText<span class="token punctuation">,</span>outerText<span class="token punctuation">,</span>oncopy<span class="token punctuation">,</span>oncut<span class="token punctuation">,</span>onpaste<span class="token punctuation">,</span>onabort<span class="token punctuation">,</span>onblur<span class="token punctuation">,</span>oncancel<span class="token punctuation">,</span>oncanplay<span class="token punctuation">,</span>oncanplaythrough<span class="token punctuation">,</span>onchange<span class="token punctuation">,</span>onclick<span class="token punctuation">,</span>onclose<span class="token punctuation">,</span>oncontextmenu<span class="token punctuation">,</span>oncuechange<span class="token punctuation">,</span>ondblclick<span class="token punctuation">,</span>ondrag<span class="token punctuation">,</span>ondragend<span class="token punctuation">,</span>ondragenter<span class="token punctuation">,</span>ondragleave<span class="token punctuation">,</span>ondragover<span class="token punctuation">,</span>ondragstart<span class="token punctuation">,</span>ondrop<span class="token punctuation">,</span>ondurationchange<span class="token punctuation">,</span>onemptied<span class="token punctuation">,</span>onended<span class="token punctuation">,</span>onerror<span class="token punctuation">,</span>onfocus<span class="token punctuation">,</span>oninput<span class="token punctuation">,</span>oninvalid<span class="token punctuation">,</span>onkeydown<span class="token punctuation">,</span>onkeypress<span class="token punctuation">,</span>onkeyup<span class="token punctuation">,</span>onload<span class="token punctuation">,</span>onloadeddata<span class="token punctuation">,</span>onloadedmetadata<span class="token punctuation">,</span>onloadstart<span class="token punctuation">,</span>onmousedown<span class="token punctuation">,</span>onmouseenter<span class="token punctuation">,</span>onmouseleave<span class="token punctuation">,</span>onmousemove<span class="token punctuation">,</span>onmouseout<span class="token punctuation">,</span>onmouseover<span class="token punctuation">,</span>onmouseup<span class="token punctuation">,</span>onmousewheel<span class="token punctuation">,</span>onpause<span class="token punctuation">,</span>onplay<span class="token punctuation">,</span>onplaying<span class="token punctuation">,</span>onprogress<span class="token punctuation">,</span>onratechange<span class="token punctuation">,</span>onreset<span class="token punctuation">,</span>onresize<span class="token punctuation">,</span>onscroll<span class="token punctuation">,</span>onseeked<span class="token punctuation">,</span>onseeking<span class="token punctuation">,</span>onselect<span class="token punctuation">,</span>onstalled<span class="token punctuation">,</span>onsubmit<span class="token punctuation">,</span>onsuspend<span class="token punctuation">,</span>ontimeupdate<span class="token punctuation">,</span>ontoggle<span class="token punctuation">,</span>onvolumechange<span class="token punctuation">,</span>onwaiting<span class="token punctuation">,</span>onwheel<span class="token punctuation">,</span>onauxclick<span class="token punctuation">,</span>ongotpointercapture<span class="token punctuation">,</span>onlostpointercapture<span class="token punctuation">,</span>onpointerdown<span class="token punctuation">,</span>onpointermove<span class="token punctuation">,</span>onpointerup<span class="token punctuation">,</span>onpointercancel<span class="token punctuation">,</span>onpointerover<span class="token punctuation">,</span>onpointerout<span class="token punctuation">,</span>onpointerenter<span class="token punctuation">,</span>onpointerleave<span class="token punctuation">,</span>onselectstart<span class="token punctuation">,</span>onselectionchange<span class="token punctuation">,</span>onanimationend<span class="token punctuation">,</span>onanimationiteration<span class="token punctuation">,</span>onanimationstart<span class="token punctuation">,</span>ontransitionend<span class="token punctuation">,</span>dataset<span class="token punctuation">,</span>nonce<span class="token punctuation">,</span>autofocus<span class="token punctuation">,</span>tabIndex<span class="token punctuation">,</span>click<span class="token punctuation">,</span>focus<span class="token punctuation">,</span>blur<span class="token punctuation">,</span>enterKeyHint<span class="token punctuation">,</span>onformdata<span class="token punctuation">,</span>onpointerrawupdate<span class="token punctuation">,</span>attachInternals<span class="token punctuation">,</span>namespaceURI<span class="token punctuation">,</span>prefix<span class="token punctuation">,</span>localName<span class="token punctuation">,</span>tagName<span class="token punctuation">,</span>id<span class="token punctuation">,</span>className<span class="token punctuation">,</span>classList<span class="token punctuation">,</span>slot<span class="token punctuation">,</span>part<span class="token punctuation">,</span>attributes<span class="token punctuation">,</span>shadowRoot<span class="token punctuation">,</span>assignedSlot<span class="token punctuation">,</span>innerHTML<span class="token punctuation">,</span>outerHTML<span class="token punctuation">,</span>scrollTop<span class="token punctuation">,</span>scrollLeft<span class="token punctuation">,</span>scrollWidth<span class="token punctuation">,</span>scrollHeight<span class="token punctuation">,</span>clientTop<span class="token punctuation">,</span>clientLeft<span class="token punctuation">,</span>clientWidth<span class="token punctuation">,</span>clientHeight<span class="token punctuation">,</span>attributeStyleMap<span class="token punctuation">,</span>onbeforecopy<span class="token punctuation">,</span>onbeforecut<span class="token punctuation">,</span>onbeforepaste<span class="token punctuation">,</span>onsearch<span class="token punctuation">,</span>elementTiming<span class="token punctuation">,</span>previousElementSibling<span class="token punctuation">,</span>nextElementSibling<span class="token punctuation">,</span>children<span class="token punctuation">,</span>firstElementChild<span class="token punctuation">,</span>lastElementChild<span class="token punctuation">,</span>childElementCount<span class="token punctuation">,</span>onfullscreenchange<span class="token punctuation">,</span>onfullscreenerror<span class="token punctuation">,</span>onwebkitfullscreenchange<span class="token punctuation">,</span>onwebkitfullscreenerror<span class="token punctuation">,</span>setPointerCapture<span class="token punctuation">,</span>releasePointerCapture<span class="token punctuation">,</span>hasPointerCapture<span class="token punctuation">,</span>hasAttributes<span class="token punctuation">,</span>getAttributeNames<span class="token punctuation">,</span>getAttribute<span class="token punctuation">,</span>getAttributeNS<span class="token punctuation">,</span>setAttribute<span class="token punctuation">,</span>setAttributeNS<span class="token punctuation">,</span>removeAttribute<span class="token punctuation">,</span>removeAttributeNS<span class="token punctuation">,</span>hasAttribute<span class="token punctuation">,</span>hasAttributeNS<span class="token punctuation">,</span>toggleAttribute<span class="token punctuation">,</span>getAttributeNode<span class="token punctuation">,</span>getAttributeNodeNS<span class="token punctuation">,</span>setAttributeNode<span class="token punctuation">,</span>setAttributeNodeNS<span class="token punctuation">,</span>removeAttributeNode<span class="token punctuation">,</span>closest<span class="token punctuation">,</span>matches<span class="token punctuation">,</span>webkitMatchesSelector<span class="token punctuation">,</span>attachShadow<span class="token punctuation">,</span>getElementsByTagName<span class="token punctuation">,</span>getElementsByTagNameNS<span class="token punctuation">,</span>getElementsByClassName<span class="token punctuation">,</span>insertAdjacentElement<span class="token punctuation">,</span>insertAdjacentText<span class="token punctuation">,</span>insertAdjacentHTML<span class="token punctuation">,</span>requestPointerLock<span class="token punctuation">,</span>getClientRects<span class="token punctuation">,</span>getBoundingClientRect<span class="token punctuation">,</span>scrollIntoView<span class="token punctuation">,</span>scroll<span class="token punctuation">,</span>scrollTo<span class="token punctuation">,</span>scrollBy<span class="token punctuation">,</span>scrollIntoViewIfNeeded<span class="token punctuation">,</span>animate<span class="token punctuation">,</span>computedStyleMap<span class="token punctuation">,</span>before<span class="token punctuation">,</span>after<span class="token punctuation">,</span>replaceWith<span class="token punctuation">,</span>remove<span class="token punctuation">,</span>prepend<span class="token punctuation">,</span>append<span class="token punctuation">,</span>querySelector<span class="token punctuation">,</span>querySelectorAll<span class="token punctuation">,</span>requestFullscreen<span class="token punctuation">,</span>webkitRequestFullScreen<span class="token punctuation">,</span>webkitRequestFullscreen<span class="token punctuation">,</span>createShadowRoot<span class="token punctuation">,</span>getDestinationInsertionPoints<span class="token punctuation">,</span><span class="token constant">ELEMENT_NODE</span><span class="token punctuation">,</span><span class="token constant">ATTRIBUTE_NODE</span><span class="token punctuation">,</span><span class="token constant">TEXT_NODE</span><span class="token punctuation">,</span><span class="token constant">CDATA_SECTION_NODE</span><span class="token punctuation">,</span><span class="token constant">ENTITY_REFERENCE_NODE</span><span class="token punctuation">,</span><span class="token constant">ENTITY_NODE</span><span class="token punctuation">,</span><span class="token constant">PROCESSING_INSTRUCTION_NODE</span><span class="token punctuation">,</span><span class="token constant">COMMENT_NODE</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_NODE</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_TYPE_NODE</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_FRAGMENT_NODE</span><span class="token punctuation">,</span><span class="token constant">NOTATION_NODE</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_DISCONNECTED</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_PRECEDING</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_FOLLOWING</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_CONTAINS</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_CONTAINED_BY</span><span class="token punctuation">,</span><span class="token constant">DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC</span><span class="token punctuation">,</span>nodeType<span class="token punctuation">,</span>nodeName<span class="token punctuation">,</span>baseURI<span class="token punctuation">,</span>isConnected<span class="token punctuation">,</span>ownerDocument<span class="token punctuation">,</span>parentNode<span class="token punctuation">,</span>parentElement<span class="token punctuation">,</span>childNodes<span class="token punctuation">,</span>firstChild<span class="token punctuation">,</span>lastChild<span class="token punctuation">,</span>previousSibling<span class="token punctuation">,</span>nextSibling<span class="token punctuation">,</span>nodeValue<span class="token punctuation">,</span>textContent<span class="token punctuation">,</span>hasChildNodes<span class="token punctuation">,</span>getRootNode<span class="token punctuation">,</span>normalize<span class="token punctuation">,</span>cloneNode<span class="token punctuation">,</span>isEqualNode<span class="token punctuation">,</span>isSameNode<span class="token punctuation">,</span>compareDocumentPosition<span class="token punctuation">,</span>contains<span class="token punctuation">,</span>lookupPrefix<span class="token punctuation">,</span>lookupNamespaceURI<span class="token punctuation">,</span>isDefaultNamespace<span class="token punctuation">,</span>insertBefore<span class="token punctuation">,</span>appendChild<span class="token punctuation">,</span>replaceChild<span class="token punctuation">,</span>removeChild<span class="token punctuation">,</span>addEventListener<span class="token punctuation">,</span>removeEventListener<span class="token punctuation">,</span>dispatchEvent
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>可以使用 Virtual DOM 来描述真实 DOM，示例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  sel<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span> <span class="token string">&quot;Hello Virtual DOM&quot;</span><span class="token punctuation">,</span>
  elm<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul><h3 id="为什么使用-virtual-dom"><a class="header-anchor" href="#为什么使用-virtual-dom">#</a> 为什么使用 Virtual DOM</h3><ul><li><p>手动操作 DOM 比较麻烦，还需要考虑浏览器兼容性问题，虽然有 jQuery 等库简化 DOM 操作，但是随着项目的复杂 DOM 操作复杂提升</p></li><li><p>为了简化 DOM 的复杂操作于是出现了各种 MVVM 框架，MVVM 框架解决了视图和状态的同步问题</p></li><li><p>为了简化视图的操作我们可以使用模板引擎，但是模板引擎没有解决跟踪状态变化的问题，于是 Virtual DOM 出现了</p></li><li><p>Virtual DOM 的好处是当状态改变时不需要立即更新 DOM，只需要创建一个虚拟树来描述 DOM， Virtual DOM 内部将弄清楚如何有效(diff)的更新 DOM</p></li><li><p>参考 github 上 <a href="https://github.com/Matt-Esch/virtual-dom" target="_blank" rel="noopener noreferrer">virtual-dom<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 的描述</p><ul><li>虚拟 DOM 可以维护程序的状态，跟踪上一次的状态</li><li>通过比较前后两次状态的差异更新真实 DOM</li></ul></li></ul><h3 id="虚拟-dom-的作用"><a class="header-anchor" href="#虚拟-dom-的作用">#</a> 虚拟 DOM 的作用</h3><ul><li><p>维护视图和状态的关系</p></li><li><p>复杂视图情况下提升渲染性能</p></li><li><p>除了渲染 DOM 以外，还可以实现 SSR(Nuxt.js/Next.js)、原生应用(Weex/React Native)、小程序(mpvue/uni-app)等</p><p><img src="/assets/img/image-20200102104642121.005a8857.png" alt="image-20200102104642121"></p></li></ul><h3 id="virtual-dom-库"><a class="header-anchor" href="#virtual-dom-库">#</a> Virtual DOM 库</h3><ul><li><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">Snabbdom<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a><ul><li>Vue 2.x 内部使用的 Virtual DOM 就是改造的 Snabbdom</li><li>大约 200 SLOC（single line of code）</li><li>通过模块可扩展</li><li>源码使用 TypeScript 开发</li><li>最快的 Virtual DOM 之一</li></ul></li><li><a href="https://github.com/Matt-Esch/virtual-dom" target="_blank" rel="noopener noreferrer">virtual-dom<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><h4 id="案例演示"><a class="header-anchor" href="#案例演示">#</a> 案例演示</h4><ul><li><a href="https://codesandbox.io/s/jq-demo-5i7qp" target="_blank" rel="noopener noreferrer">jQuery-demo<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://codesandbox.io/s/snabbdom-demo-4hbyb" target="_blank" rel="noopener noreferrer">snabbdom-demo<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><h2 id="snabbdom-基本使用"><a class="header-anchor" href="#snabbdom-基本使用">#</a> Snabbdom 基本使用</h2><h3 id="创建项目"><a class="header-anchor" href="#创建项目">#</a> 创建项目</h3><ul><li><p>打包工具为了方便使用 <a href="https://parceljs.org/getting_started.html" target="_blank" rel="noopener noreferrer">parcel<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p></li><li><p>创建项目，并安装 <a href="https://parceljs.org/getting_started.html" target="_blank" rel="noopener noreferrer">parcel<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建项目目录</span>
md snabbdom-demo
<span class="token comment"># 进入项目目录</span>
<span class="token builtin class-name">cd</span> snabbdom-demo
<span class="token comment"># 创建 package.json</span>
<span class="token function">npm</span> init -y
<span class="token comment"># 本地安装 parcel</span>
<span class="token function">npm</span> <span class="token function">install</span> parcel-bundler -D
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>配置 package.json 的 scripts</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;parcel index.html --open&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;parcel build index.html&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>创建目录结构</p><div class="language-txt ext-txt line-numbers-mode"><pre class="language-txt"><code>│  index.html
│  package.json
└─src
     		01-basicusage.js
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul><h3 id="导入-snabbdom"><a class="header-anchor" href="#导入-snabbdom">#</a> 导入 Snabbdom</h3><h4 id="snabbdom-文档"><a class="header-anchor" href="#snabbdom-文档">#</a> Snabbdom 文档</h4><ul><li><p>看文档的意义</p><ul><li>学习任何一个库都要先看文档</li><li>通过文档了解库的作用</li><li>看文档中提供的示例，自己快速实现一个 demo</li><li>通过文档查看 API 的使用</li></ul></li><li><p>文档地址</p><ul><li>https://github.com/snabbdom/snabbdom</li><li>当前版本 v2.1.0</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># --depth 表示克隆深度, 1 表示只克隆最新的版本. 因为如果项目迭代的版本很多, 克隆会很慢</span>
<span class="token function">git</span> clone -b v2.1.0 --depth<span class="token operator">=</span><span class="token number">1</span> https://github.com/snabbdom/snabbdom.git
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul><h4 id="安装-snabbdom"><a class="header-anchor" href="#安装-snabbdom">#</a> 安装 Snabbdom</h4><ul><li><p>安装 Snabbdom</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> snabbdom@2.1.0
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li></ul><h4 id="导入-snabbdom-1"><a class="header-anchor" href="#导入-snabbdom-1">#</a> 导入 Snabbdom</h4><ul><li>Snabbdom 的两个核心函数 init 和 h() <ul><li>init() 是一个高阶函数，返回 patch()</li><li>h() 返回虚拟节点 VNode，这个函数我们在使用 Vue.js 的时候见过</li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/init&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/h&#39;</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>注意：此时运行的话会告诉我们找不到 init / h 模块，因为模块路径并不是 snabbdom/int，这个路径是在 package.json 中的 exports 字段设置的，而我们使用的打包工具不支持 exports 这个字段，webpack 4 也不支持，webpack 5 支持该字段。该字段在导入 snabbdom/init 的时候会补全路径成 snabbdom/build/package/init.js</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&quot;exports&quot;: {
    &quot;./init&quot;: &quot;./build/package/init.js&quot;,
    &quot;./h&quot;: &quot;./build/package/h.js&quot;,
    &quot;./helpers/attachto&quot;: &quot;./build/package/helpers/attachto.js&quot;,
    &quot;./hooks&quot;: &quot;./build/package/hooks.js&quot;,
    &quot;./htmldomapi&quot;: &quot;./build/package/htmldomapi.js&quot;,
    &quot;./is&quot;: &quot;./build/package/is.js&quot;,
    &quot;./jsx&quot;: &quot;./build/package/jsx.js&quot;,
    &quot;./modules/attributes&quot;: &quot;./build/package/modules/attributes.js&quot;,
    &quot;./modules/class&quot;: &quot;./build/package/modules/class.js&quot;,
    &quot;./modules/dataset&quot;: &quot;./build/package/modules/dataset.js&quot;,
    &quot;./modules/eventlisteners&quot;: &quot;./build/package/modules/eventlisteners.js&quot;,
    &quot;./modules/hero&quot;: &quot;./build/package/modules/hero.js&quot;,
    &quot;./modules/module&quot;: &quot;./build/package/modules/module.js&quot;,
    &quot;./modules/props&quot;: &quot;./build/package/modules/props.js&quot;,
    &quot;./modules/style&quot;: &quot;./build/package/modules/style.js&quot;,
    &quot;./thunk&quot;: &quot;./build/package/thunk.js&quot;,
    &quot;./tovnode&quot;: &quot;./build/package/tovnode.js&quot;,
    &quot;./vnode&quot;: &quot;./build/package/vnode.js&quot;
  }
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>如果使用不支持 package.json 的 exports 字段的打包工具，我们应该把模块的路径写全 <ul><li>查看安装的 snabbdom 的目录结构</li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/h&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/init&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> classModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/modules/class&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>回顾 Vue 中的 render 函数</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  router<span class="token punctuation">,</span>
  store<span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>thunk() 是一种优化策略，可以在处理不可变数据时使用</li></ul><h3 id="代码演示"><a class="header-anchor" href="#代码演示">#</a> 代码演示</h3><h4 id="基本使用"><a class="header-anchor" href="#基本使用">#</a> 基本使用</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/h&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/init&#39;</span>

<span class="token comment">// 使用 init() 函数创建 patch()</span>
<span class="token comment">// init() 的参数是数组，将来可以传入模块，处理属性/样式/事件等</span>
<span class="token keyword">let</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 使用 h() 函数创建 vnode</span>
<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div.cls&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello Snabbdom&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;这是段落&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
<span class="token comment">// 把 vnode 渲染到空的 DOM 元素（替换）</span>
<span class="token comment">// 会返回新的 vnode</span>
<span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div.cls&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello World&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;这是段落&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">// 把老的视图更新到新的状态</span>
  oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token comment">// h(&#39;!&#39;) 是创建注释</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="模块"><a class="header-anchor" href="#模块">#</a> 模块</h4><p>Snabbdom 的核心库并不能处理 DOM 元素的属性/样式/事件等，如果需要处理的话，可以使用模块</p><h4 id="常用模块"><a class="header-anchor" href="#常用模块">#</a> 常用模块</h4><ul><li><p>官方提供了 6 个模块</p><ul><li>attributes <ul><li>设置 DOM 元素的属性，使用 <code>setAttribute</code>()</li><li>处理布尔类型的属性</li></ul></li><li>props <ul><li>和 <code>attributes</code> 模块相似，设置 DOM 元素的属性 <code>element[attr] = value</code></li><li>不处理布尔类型的属性</li></ul></li><li>class <ul><li>切换类样式</li><li>注意：给元素设置类样式是通过 <code>sel</code> 选择器</li></ul></li><li>dataset <ul><li>设置 <code>data-*</code> 的自定义属性</li></ul></li><li>eventlisteners <ul><li>注册和移除事件</li></ul></li><li>style <ul><li>设置行内样式，支持动画</li><li>delayed/remove/destroy</li></ul></li></ul></li></ul><h4 id="模块使用"><a class="header-anchor" href="#模块使用">#</a> 模块使用</h4><ul><li>模块使用步骤： <ul><li>导入需要的模块</li><li>init() 中注册模块</li><li>使用 h() 函数创建 VNode 的时候，可以把第二个参数设置为对象，其他参数往后移</li></ul></li></ul><h4 id="代码演示-1"><a class="header-anchor" href="#代码演示-1">#</a> 代码演示</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/h&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/init&#39;</span>
<span class="token comment">// 导入需要的模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> styleModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/modules/style&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventListenersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;snabbdom/build/package/modules/eventlisteners&#39;</span>

<span class="token comment">// 使用 init() 函数创建 patch()</span>
<span class="token comment">// init() 的参数是数组，将来可以传入模块，处理属性/样式/事件等</span>
<span class="token keyword">let</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">// 注册模块</span>
  styleModule<span class="token punctuation">,</span>
  eventListenersModule
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 使用 h() 函数创建 vnode</span>
<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div.cls&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置 DOM 元素的行内样式</span>
  style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">&#39;#DEDEDE&#39;</span><span class="token punctuation">,</span> backgroundColor<span class="token operator">:</span> <span class="token string">&#39;#181A1B&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 注册事件</span>
  on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> clickHandler <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello Snabbdom&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;这是段落&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">clickHandler</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此处的 this 指向对应的 vnode</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>elm<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="snabbdom-源码解析"><a class="header-anchor" href="#snabbdom-源码解析">#</a> Snabbdom 源码解析</h2><h3 id="如何学习源码"><a class="header-anchor" href="#如何学习源码">#</a> 如何学习源码</h3><ul><li>先宏观了解</li><li>带着目标看源码</li><li>看源码的过程要不求甚解</li><li>调试</li><li>参考资料</li></ul><h3 id="snabbdom-的核心"><a class="header-anchor" href="#snabbdom-的核心">#</a> Snabbdom 的核心</h3><ul><li>使用 h() 函数创建 JavaScript 对象(VNode)描述真实 DOM</li><li>init() 设置模块，创建 patch()</li><li>patch() 比较新旧两个 VNode</li><li>把变化的内容更新到真实 DOM 树上</li></ul><h3 id="snabbdom-源码"><a class="header-anchor" href="#snabbdom-源码">#</a> Snabbdom 源码</h3><ul><li><p>源码地址：</p><ul><li>https://github.com/snabbdom/snabbdom</li></ul></li><li><p>src 目录结构</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>├── package
│   ├── helpers
│   │   └── attachto.ts		定义了 vnode.ts 中 AttachData 的数据结构
│   ├── modules
│   │   ├── attributes.ts
│   │   ├── class.ts
│   │   ├── dataset.ts
│   │   ├── eventlisteners.ts
│   │   ├── hero.ts				example 中使用到的自定义钩子
│   │   ├── module.ts			定义了模块中用到的钩子函数
│   │   ├── props.ts
│   │   └── style.ts
│   ├── h.ts							h() 函数，用来创建 VNode
│   ├── hooks.ts					所有钩子函数的定义
│   ├── htmldomapi.ts			对 DOM API 的包装
│   ├── init.ts						加载 modules、DOMAPI，返回 patch 函数
│   ├── is.ts							判断数组和原始值的函数
│   ├── jsx-global.ts			jsx 的类型声明文件
│   ├── jsx.ts						处理 jsx
│   ├── thunk.ts					优化处理，对复杂视图不可变值得优化
│   ├── tovnode.ts				DOM 转换成 VNode
│   ├── ts-transform-js-extension.cjs
│   ├── tsconfig.json			ts 的编译配置文件
│   └── vnode.ts					虚拟节点定义
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li></ul><h3 id="h-函数"><a class="header-anchor" href="#h-函数">#</a> h 函数</h3><ul><li><p>h() 函数介绍</p><ul><li><p>在使用 Vue 的时候见过 h() 函数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  router<span class="token punctuation">,</span>
  store<span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>h() 函数最早见于 <a href="https://github.com/hyperhype/hyperscript" target="_blank" rel="noopener noreferrer">hyperscript<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，使用 JavaScript 创建超文本</p></li><li><p>Snabbdom 中的 h() 函数不是用来创建超文本，而是创建 VNode</p></li></ul></li><li><p>函数重载</p><ul><li><p>概念</p><ul><li><strong>参数个数</strong>或<strong>类型</strong>不同的函数</li><li>JavaScript 中没有重载的概念</li><li>TypeScript 中有重载，不过重载的实现还是通过代码调整参数</li></ul></li><li><p>重载的示意</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> number<span class="token punctuation">,</span> b<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> number<span class="token punctuation">,</span> b<span class="token operator">:</span> number<span class="token punctuation">,</span> c<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> number<span class="token punctuation">,</span> b<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> number<span class="token punctuation">,</span> b<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;2&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul></li><li><p>源码位置：src/package/h.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// h 函数的重载</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> any<span class="token punctuation">,</span> b<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> c<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data<span class="token operator">:</span> VNodeData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">var</span> children<span class="token operator">:</span> any
  <span class="token keyword">var</span> text<span class="token operator">:</span> any
  <span class="token keyword">var</span> i<span class="token operator">:</span> number
  <span class="token comment">// 处理参数，实现重载的机制</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理三个参数的情况</span>
    <span class="token comment">// sel、data、children/text</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data <span class="token operator">=</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> c
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> c
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 c 是字符串或者数字</span>
      text <span class="token operator">=</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 b 是 VNode</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> data <span class="token operator">=</span> b <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 children 中的原始值(string/number)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 child 是 string/number，创建文本节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    sel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;s&#39;</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;v&#39;</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;g&#39;</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>sel<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;.&#39;</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是 svg，添加命名空间</span>
    <span class="token function">addNS</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> sel<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回 VNode</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div></li></ul><h3 id="vnode"><a class="header-anchor" href="#vnode">#</a> VNode</h3><ul><li><p>一个 VNode 就是一个虚拟节点用来描述一个 DOM 元素，如果这个 VNode 有 children 就是 Virtual DOM</p></li><li><p>源码位置：src/package/vnode.ts</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  <span class="token comment">// 选择器</span>
  sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 节点数据：属性/样式/事件等</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 子节点，和 text 只能互斥</span>
  children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 记录 vnode 对应的真实 DOM</span>
  elm<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 节点中的内容，和 children 只能互斥</span>
  text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 优化用</span>
  key<span class="token operator">:</span> Key <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      data<span class="token operator">:</span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                      elm<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>key
  <span class="token keyword">return</span> <span class="token punctuation">{</span> sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> key <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="snabbdom"><a class="header-anchor" href="#snabbdom">#</a> snabbdom</h3><ul><li>patch(oldVnode, newVnode)</li><li>打补丁，把新节点中变化的内容渲染到真实 DOM，最后返回新节点作为下一次处理的旧节点</li><li>对比新旧 VNode 是否相同节点(节点的 key 和 sel 相同)</li><li>如果不是相同节点，删除之前的内容，重新渲染</li><li>如果是相同节点，再判断新的 VNode 是否有 text，如果有并且和 oldVnode 的 text 不同，直接更新文本内容</li><li>如果新的 VNode 有 children，判断子节点是否有变化，判断子节点的过程使用的就是 diff 算法</li><li>diff 过程只进行同层级比较</li></ul><p><img src="/assets/img/image-20200102103653779.b20192d5.png" alt="image-20200102103653779"></p><h3 id="init"><a class="header-anchor" href="#init">#</a> init</h3><ul><li><p>**功能：**init(modules, domApi)，返回 patch() 函数（高阶函数）</p></li><li><p>为什么要使用高阶函数？</p><ul><li>因为 patch() 函数再外部会调用多次，每次调用依赖一些参数，比如：modules/domApi/cbs</li><li>通过高阶函数让 init() 内部形成闭包，返回的 patch() 可以访问到 modules/domApi/cbs，而不需要重新创建</li></ul></li><li><p>init() 在返回 patch() 之前，首先收集了所有模块中的钩子函数存储到 cbs 对象中</p></li><li><p>源码位置：src/package/init.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> hooks<span class="token operator">:</span> Array<span class="token operator">&lt;</span>keyof Module<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;create&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;remove&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;destroy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pre&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">]</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">modules<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Partial<span class="token operator">&lt;</span>Module<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> domApi<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token operator">:</span> number
  <span class="token keyword">let</span> j<span class="token operator">:</span> number
  <span class="token keyword">const</span> cbs<span class="token operator">:</span> ModuleHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    destroy<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pre<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化 api</span>
  <span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi
  <span class="token comment">// 把传入的所有模块的钩子方法，统一存储到 cbs 对象中</span>
  <span class="token comment">// 最终构建的 cbs 对象的形式 cbs = [ create: [fn1, fn2], update: [], ... ]</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cbs[&#39;create&#39;] = []</span>
    cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// const hook = modules[0][&#39;create&#39;]</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ……
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
    ……
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li></ul><h3 id="patch"><a class="header-anchor" href="#patch">#</a> patch</h3><ul><li><p><strong>功能：</strong></p><ul><li>传入新旧 VNode，对比差异，把差异渲染到 DOM</li><li>返回新的 VNode，作为下一次 patch() 的 oldVnode</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>首先执行<strong>模块</strong>中的<strong>钩子</strong>函数 <code>pre</code></li><li>如果 oldVnode 和 vnode 相同（key 和 sel 相同） <ul><li>调用 patchVnode()，找节点的差异并更新 DOM</li></ul></li><li>如果 oldVnode 是 DOM 元素 <ul><li>把 DOM 元素转换成 oldVnode</li><li>调用 createElm() 把 vnode 转换为真实 DOM，记录到 vnode.elm</li><li>把刚创建的 DOM 元素插入到 parent 中</li><li>移除老节点</li><li>触发<strong>用户</strong>设置的 <code>create </code> <strong>钩子</strong>函数</li></ul></li></ul></li><li><p>源码位置：src/package/init.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token operator">:</span> number<span class="token punctuation">,</span> elm<span class="token operator">:</span> Node<span class="token punctuation">,</span> parent<span class="token operator">:</span> Node
  <span class="token comment">// 保存新插入节点的队列，为了触发钩子函数</span>
  <span class="token keyword">const</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 执行模块的 pre 钩子函数</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 如果 oldVnode 不是 VNode，创建 VNode 并设置 elm </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把 DOM 元素转换成空的 VNode</span>
    oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 如果新旧节点是相同节点(key 和 sel 相同)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找节点的差异并更新 DOM</span>
    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果新旧节点不同，vnode 创建对应的 DOM</span>
    <span class="token comment">// 获取当前的 DOM 元素</span>
    elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
    parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span> <span class="token keyword">as</span> Node
		<span class="token comment">// 触发 init/create 钩子函数,创建 DOM</span>
    <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果父节点不为空，把 vnode 对应的 DOM 插入到文档中</span>
      api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 移除老节点</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 执行用户设置的 insert 钩子函数</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insertedVnodeQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token operator">!</span><span class="token punctuation">.</span>insert<span class="token operator">!</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行模块的 post 钩子函数</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div></li></ul><h3 id="createelm"><a class="header-anchor" href="#createelm">#</a> createElm</h3><ul><li><p><strong>功能：</strong></p><ul><li>createElm(vnode, insertedVnodeQueue)，返回创建的 DOM 元素</li><li>创建 vnode 对应的 DOM 元素</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>首先触发<strong>用户</strong>设置的 <strong>init</strong> <strong>钩子</strong>函数</li><li>如果选择器是!，创建评论节点</li><li>如果选择器为空，创建文本节点</li><li>如果选择器不为空 <ul><li>解析选择器，设置标签的 id 和 class 属性</li><li>执行<strong>模块</strong>的 <strong>create</strong> <strong>钩子</strong>函数</li><li>如果 vnode 有 children，创建子 vnode 对应的 DOM，追加到 DOM 树</li><li>如果 vnode 的 text 值是 string/number，创建文本节点并追击到 DOM 树</li><li>执行<strong>用户</strong>设置的 <strong>create</strong> <strong>钩子</strong>函数</li><li>如果有用户设置的 insert 钩子函数，把 vnode 添加到队列中</li></ul></li></ul></li><li><p>源码位置：src/package/init.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> any
    <span class="token keyword">let</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行用户设置的 init 钩子函数</span>
      <span class="token keyword">const</span> init <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>init
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
        data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">&#39;!&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果选择器是!，创建注释节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      <span class="token punctuation">}</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果选择器不为空</span>
      <span class="token comment">// 解析选择器</span>
      <span class="token comment">// Parse selector</span>
      <span class="token keyword">const</span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span>
      <span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length
      <span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length
      <span class="token keyword">const</span> tag <span class="token operator">=</span> hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> sel
      <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>ns<span class="token punctuation">)</span>
        <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
        <span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 执行模块的 create 钩子函数</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      <span class="token comment">// 如果 vnode 中有子节点，创建子 vnode 对应的 DOM 元素并追加到 DOM 树上</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 vnode 的 text 值是 string/number，创建文本节点并追加到 DOM 树</span>
        api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行用户传入的钩子 create</span>
        hook<span class="token punctuation">.</span>create<span class="token operator">?.</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 把 vnode 添加到队列中，为后续执行 insert 钩子做准备</span>
          insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果选择器为空，创建文本节点</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回新创建的 DOM                                </span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div></li></ul><h3 id="patchvnode"><a class="header-anchor" href="#patchvnode">#</a> patchVnode</h3><ul><li><p><strong>功能：</strong></p><ul><li>patchVnode(oldVnode, vnode, insertedVnodeQueue)</li><li>对比 oldVnode 和 vnode 的差异，把差异渲染到 DOM</li></ul><p><img src="/assets/img/patchVnode.0fbf498c.jpg" alt="img"></p></li><li><p><strong>执行过程：</strong></p><ul><li>首先执行<strong>用户</strong>设置的 <strong>prepatch</strong> <strong>钩子</strong>函数</li><li>执行 create 钩子函数 <ul><li>首先执行<strong>模块</strong>的 <strong>create</strong> <strong>钩子</strong>函数</li><li>然后执行<strong>用户</strong>设置的 <strong>create</strong> <strong>钩子</strong>函数</li></ul></li><li>如果 <strong>vnode.text</strong> 未定义 <ul><li>如果 <code>oldVnode.children</code> 和 <code>vnode.children</code> 都有值 <ul><li>调用 <code>updateChildren()</code></li><li>使用 diff 算法对比子节点，更新子节点</li></ul></li><li>如果 <code>vnode.children</code> 有值，<code>oldVnode.children</code> 无值 <ul><li>清空 DOM 元素</li><li>调用 <code>addVnodes()</code>，批量添加子节点</li></ul></li><li>如果 <code>oldVnode.children</code> 有值，<code>vnode.children</code> 无值 <ul><li>调用 <code>removeVnodes()</code>，批量移除子节点</li></ul></li><li>如果 <strong>oldVnode.text</strong> 有值 <ul><li>清空 DOM 元素的内容</li></ul></li></ul></li><li>如果设置了 <code>vnode.text</code> 并且和和 <code>oldVnode.text</code> 不等 <ul><li>如果老节点有子节点，全部移除</li><li>设置 DOM 元素的 <code>textContent</code> 为 <code>vnode.text</code></li></ul></li><li>最后执行用户<strong>设置的</strong> <strong>postpatch</strong> <strong>钩子</strong>函数</li></ul></li><li><p>源码位置：src/package/init.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">?.</span>hook
    <span class="token comment">// 首先执行用户设置的 prepatch 钩子函数</span>
    hook<span class="token operator">?.</span>prepatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
    <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
  	<span class="token comment">// 如果新老 vnode 相同返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行模块的 update 钩子函数</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      <span class="token comment">// 执行用户设置的 update 钩子函数</span>
      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>update<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 如果 vnode.text 未定义</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果新老节点都有 children</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用 updateChildren 对比子节点，更新子节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果新节点有 children，老节点没有 children</span>
      	<span class="token comment">// 如果老节点有text，清空dom 元素的内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
        <span class="token comment">// 批量添加子节点</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果老节点有children，新节点没有children</span>
      	<span class="token comment">// 批量移除子节点</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果老节点有 text，清空 DOM 元素</span>
        api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有设置 vnode.text</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果老节点有 children，移除</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 设置 DOM 元素的 textContent 为 vnode.text</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最后执行用户设置的 postpatch 钩子函数</span>
    hook<span class="token operator">?.</span>postpatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div></li></ul><h3 id="updatechildren"><a class="header-anchor" href="#updatechildren">#</a> updateChildren</h3><ul><li><p><strong>功能：</strong></p><ul><li>diff 算法的核心，对比新旧节点的 children，更新 DOM</li></ul></li><li><p><strong>执行过程：</strong></p><ul><li>要对比两棵树的差异，我们可以取第一棵树的每一个节点依次和第二课树的每一个节点比较，但是这样的时间复杂度为 O(n^3)</li><li>在DOM 操作的时候我们很少很少会把一个父节点移动/更新到某一个子节点</li><li>因此只需要找<strong>同级别</strong>的子<strong>节点</strong>依次<strong>比较</strong>，然后再找下一级别的节点比较，这样算法的时间复杂度为 O(n)</li></ul><p><img src="/assets/img/image-20200102103653779.b20192d5.png" alt="image-20200102103653779.png"></p><ul><li>在进行同级别节点比较的时候，首先会对新老节点数组的开始和结尾节点设置标记索引，遍历的过程中移动索引</li><li>在对<strong>开始和结束节点</strong>比较的时候，总共有四种情况 <ul><li>oldStartVnode / newStartVnode (旧开始节点 / 新开始节点)</li><li>oldEndVnode / newEndVnode (旧结束节点 / 新结束节点)</li><li>oldStartVnode / oldEndVnode (旧开始节点 / 新结束节点)</li><li>oldEndVnode / newStartVnode (旧结束节点 / 新开始节点)</li></ul></li></ul><p><img src="/assets/img/image-20200109184608649.b0eb7670.png" alt="image-20200109184608649"></p><ul><li>开始节点和结束节点比较，这两种情况类似 <ul><li>oldStartVnode / newStartVnode (旧开始节点 / 新开始节点)</li><li>oldEndVnode / newEndVnode (旧结束节点 / 新结束节点)</li></ul></li><li>如果 oldStartVnode 和 newStartVnode 是 sameVnode (key 和 sel 相同) <ul><li>调用 patchVnode() 对比和更新节点</li><li>把旧开始和新开始索引往后移动 oldStartIdx++ / oldEndIdx++</li></ul></li></ul><p><img src="/assets/img/image-20200103121812840.94678028.png" alt="image-20200103121812840"></p><ul><li>oldStartVnode / newEndVnode (旧开始节点 / 新结束节点) 相同 <ul><li>调用 patchVnode() 对比和更新节点</li><li>把 oldStartVnode 对应的 DOM 元素，移动到右边 - 更新索引</li></ul></li></ul><p><img src="/assets/img/image-20200103125428541.937ab20a.png" alt="image-20200103125428541"></p><ul><li>oldEndVnode / newStartVnode (旧结束节点 / 新开始节点) 相同 <ul><li>调用 patchVnode() 对比和更新节点</li><li>把 oldEndVnode 对应的 DOM 元素，移动到左边</li><li>更新索引</li></ul></li></ul><p><img src="/assets/img/image-20200103125735048.e9b53c0c.png" alt="image-20200103125735048"></p><ul><li>如果不是以上四种情况 <ul><li>遍历新节点，使用 newStartNode 的 key 在老节点数组中找相同节点</li><li>如果没有找到，说明 newStartNode 是新节点 <ul><li>创建新节点对应的 DOM 元素，插入到 DOM 树中</li></ul></li><li>如果找到了 <ul><li>判断新节点和找到的老节点的 sel 选择器是否相同</li><li>如果不相同，说明节点被修改了 <ul><li>重新创建对应的 DOM 元素，插入到 DOM 树中</li></ul></li><li>如果相同，把 elmToMove 对应的 DOM 元素，移动到左边</li></ul></li></ul></li></ul><p><img src="/assets/img/image-20200109184822439.9ffa2126.png" alt="image-20200109184822439"></p><ul><li>循环结束 <ul><li>当老节点的所有子节点先遍历完 (oldStartIdx &gt; oldEndIdx)，循环结束</li><li>新节点的所有子节点先遍历完 (newStartIdx &gt; newEndIdx)，循环结束</li></ul></li><li>如果老节点的数组先遍历完(oldStartIdx &gt; oldEndIdx)，说明新节点有剩余，把剩余节点批量插入到右边</li></ul><p><img src="/assets/img/image-20200103150918335.2cc690c2.png" alt="image-20200103150918335"></p><p>​</p><ul><li>如果新节点的数组先遍历完(newStartIdx &gt; newEndIdx)，说明老节点有剩余，把剩余节点批量删除</li></ul><p><img src="/assets/img/image-20200109194751093.7e167e5a.png" alt="image-20200109194751093"></p></li><li><p>源码位置：src/package/init.ts</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
  oldCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  newCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
  <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>
  <span class="token keyword">let</span> oldKeyToIdx<span class="token operator">:</span> KeyToIndexMap <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token keyword">let</span> idxInOld<span class="token operator">:</span> number
  <span class="token keyword">let</span> elmToMove<span class="token operator">:</span> VNode
  <span class="token keyword">let</span> before<span class="token operator">:</span> any

  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 索引变化后，可能会把节点设置为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 节点为空移动索引</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span> <span class="token comment">// Vnode might have been moved left</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
    <span class="token comment">// 比较开始和结束节点的四种情况</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 比较老开始节点和新的开始节点</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. 比较老结束节点和新的结束节点</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
      <span class="token comment">// 3. 比较老开始节点和新的结束节点</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
      <span class="token comment">// 4. 比较老结束节点和新的开始节点</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 开始节点和结束节点都不相同</span>
      <span class="token comment">// 使用 newStartNode 的 key 再老节点数组中找相同节点</span>
      <span class="token comment">// 先设置记录 key 和 index 的对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 遍历 newStartVnode, 从老的节点中找相同 key 的 oldVnode 的索引</span>
      idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> string<span class="token punctuation">]</span>
      <span class="token comment">// 如果是新的vnode</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
        <span class="token comment">// 如果没找到，newStartNode 是新节点</span>
        <span class="token comment">// 创建元素插入 DOM 树</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果找到相同 key 相同的老节点，记录到 elmToMove 遍历</span>
        elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果新旧节点的选择器不同</span>
          <span class="token comment">// 创建新开始节点对应的 DOM 元素，插入到 DOM 树中</span>
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果相同，patchVnode()</span>
          <span class="token comment">// 把 elmToMove 对应的 DOM 元素，移动到左边</span>
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
          oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> any
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> elmToMove<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 重新给 newStartVnode 赋值，指向下一个新节点</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 循环结束，老节点数组先遍历完成或者新节点数组先遍历完成</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果老节点数组先遍历完成，说明有新的节点剩余</span>
      <span class="token comment">// 把剩余的新节点都插入到右边</span>
      before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> before<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果新节点数组先遍历完成，说明老节点有剩余</span>
      <span class="token comment">// 批量删除老节点</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div></li></ul><h3 id="调试-updatechildren"><a class="header-anchor" href="#调试-updatechildren">#</a> 调试 updateChildren</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>微博<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>视频<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>视频<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>微博<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/assets/img/image-20200112120036948.2c707b62.png" alt="image-20200112120036948"></p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/1/2021, 5:32:52 PM</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/guide/vue/vuex.html" class="nav-link" aria-label="Vuex"><!--[--><!--]--> Vuex <!--[--><!--]--></a></span><span class="next"><a href="/guide/vue/diff%E7%AE%97%E6%B3%95.html" class="nav-link" aria-label="Diff 算法"><!--[--><!--]--> Diff 算法 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.89d2221a.js" defer></script><script src="/assets/js/640.35c7ecf5.js" defer></script><script src="/assets/js/app.983a575d.js" defer></script>
  </body>
</html>
